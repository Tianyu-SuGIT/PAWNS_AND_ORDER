<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Horse race?</title>
    <style>
        :root { --c-blue: #007bff; --c-green: #28a745; --c-red: #d9534f; --c-light-gray: #f8f9fa; --c-white: #fff; --c-text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f4f9; color: var(--c-text); font-size: 16px; }
        .hidden { display: none !important; }
        .card { background: var(--c-white); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        button { padding: 10px 20px; border: none; border-radius: 4px; background-color: var(--c-blue); color: white; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #lobby-view, #game-over-view { text-align: center; padding-top: 50px; }
        .container { background-color: var(--c-white); margin: auto; padding: 20px 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 600px; }
        #player-list { list-style-type: none; padding: 0; }
        #player-list li { background-color: #e7f3ff; margin: 5px 0; padding: 10px; border-radius: 4px; }
        #lobby-view input[type="text"] { padding: 10px; width: 60%; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #lobby-status { margin-top: 20px; font-weight: bold; min-height: 20px; color: var(--c-blue); }
        #game-view { display: grid; grid-template-columns: 280px 1fr 320px; grid-template-rows: auto 1fr; gap: 20px; padding: 20px; max-width: 1500px; margin: auto; height: 95vh; }
        .game-header { grid-column: 1 / -1; text-align: center; }
        .leaderboard { grid-column: 1; grid-row: 2; }
        .main-game { grid-column: 2; grid-row: 2; display: flex; flex-direction: column; text-align: center; }
        .chat-area { grid-column: 3; grid-row: 2; display: flex; flex-direction: column; }
        #timer { font-size: 1.8em; font-weight: bold; color: var(--c-red); }
        #round-info { font-size: 1.2em; }
        #leaderboard-list { list-style: none; padding: 0; }
        #leaderboard-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; transition: background-color 0.3s; }
        #leaderboard-list li.score-update { background-color: #fffbe6; }
        .player-id-color { padding: 2px 6px; border-radius: 4px; color: white; margin-right: 8px; }
        .map-container { display: flex; justify-content: center; align-items: center; padding: 20px; background: #f0f0f0; border-radius: 8px; margin: 20px 0; }
        .map-square { width: 60px; height: 60px; border: 2px solid #ccc; background-color: var(--c-white); margin: 0 5px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; font-weight: bold; cursor: pointer; transition: all 0.2s ease; border-radius: 6px; position: relative; }
        .map-square.selected { border-color: var(--c-blue); background-color: #cce5ff; transform: scale(1.05); }
        .map-square.confirmed { border-color: var(--c-green); background-color: #d4edda; }
        .map-square.reveal .player-tokens { transform: scale(1.1); }
        .square-number { font-size: 0.8em; color: #888; margin-top: 4px; }
        .player-tokens { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; flex-grow: 1; transition: transform 0.3s; }
        .player-token { width: 20px; height: 20px; border-radius: 50%; color: white; font-size: 0.8em; font-weight: bold; display: flex; justify-content: center; align-items: center; margin: 1px; }
        .G1-token { background-color: #d9534f; } .G2-token { background-color: #5bc0de; } .G3-token { background-color: #5cb85c; } .G4-token { background-color: #f0ad4e; } .G5-token { background-color: #6f42c1; } .G6-token { background-color: #6610f2; }
        #confirm-choice-btn { margin: 10px auto; width: 80%; }
        #objectives-container { background: #e7f3ff; padding: 20px; border-radius: 8px; font-size: 1.1em; border: 2px solid var(--c-blue); box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: left; }
        .objective { margin-bottom: 10px; }
        .objective strong { color: var(--c-blue); display: block; margin-bottom: 5px; }
        .chat-tabs { display: flex; border-bottom: 1px solid #ccc; }
        .chat-tab { position: relative; padding: 10px 15px; cursor: pointer; background: #eee; border-top-left-radius: 4px; border-top-right-radius: 4px; }
        .chat-tab.active { background: var(--c-white); border-bottom: 1px solid var(--c-white); margin-bottom: -1px; font-weight: bold; }
        .unread-dot { position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background-color: var(--c-red); border-radius: 50%; display: none; }
        .chat-tab.has-unread .unread-dot { display: block; }
        .chat-window { flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; border-top: none; padding: 10px; }
        .chat-window p { margin: 0 0 5px 0; padding: 0; font-size: 0.95em; }
        .chat-input { display: flex; margin-top: 10px; }
        .chat-input input { flex-grow: 1; border: 1px solid #ccc; padding: 8px; border-radius: 4px 0 0 4px; }
        .chat-input button { border-radius: 0 4px 4px 0; }
    </style>
</head>
<body>

    <div id="lobby-view">
        <div class="container">
            <h1>Horse race?</h1>
            <h2>Lobby</h2>
            <div id="join-form">
                <input type="text" id="username-input" placeholder="Inserisci il tuo nome...">
                <button id="join-btn">Entra</button>
            </div>
            <hr>
            <h3>Giocatori Connessi:</h3>
            <ul id="player-list"></ul>
            <p id="lobby-status">Connessione al server...</p>

            <div id="game-rules" class="card" style="margin-top: 20px; text-align: left;">
                <h3>Regole del Gioco</h3>
                <p>Benvenuto! L'obiettivo è accumulare più punti degli altri in 5 round, ma non sarà semplice. Ogni tua scelta sarà un dilemma strategico.</p>
                
                <h4>Obiettivi del Round</h4>
                <p>Ogni round riceverai due tipi di obiettivi:</p>
                <ul>
                    <li><strong>Obiettivo Comune (Visibile a tutti):</strong> Una condizione uguale per tutti che crea punti di scontro sulla mappa. Vale pochi punti.</li>
                    <li><strong>Obiettivo Personale (Segreto):</strong> Visibile solo a te. È un obiettivo complesso e vale molti punti. Potrebbe chiederti di raggiungere certe zone, di prevedere le mosse di un avversario, di sabotare i piani altrui o persino di collaborare in modi inaspettati.</li>
                </ul>

                <h4>Punteggio e Conflitti</h4>
                <p>Presta attenzione a questa regola fondamentale:</p>
                <ul>
                    <li>La regola più importante: se termini un round su una casella insieme a uno o più altri giocatori, **generalmente non ottieni punti né dal tuo obiettivo personale, né da quello comune.**</li>
                    <li><strong>L'eccezione:</strong> Alcuni Obiettivi Comuni potrebbero **cambiare le regole del round!** Per esempio, un obiettivo potrebbe premiare esplicitamente i giocatori che riescono a formare una coppia su una casella, annullando la penalità.</li>
                </ul>
                <p>Questo crea il dilemma centrale del gioco: ti conviene rischiare di andare in una casella affollata per l'obiettivo comune, o giocare sul sicuro per il tuo obiettivo segreto?</p>

                 <h4>Info Generali</h4>
                <ul>
                    <li><strong>Giocatori:</strong> Da 4 a 6 giocatori.</li>
                    <li><strong>Timer di Round:</strong> 3 minuti.</li>
                    <li><strong>Vincitore:</strong> Chi ha più punti dopo 5 round vince!</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="game-view" class="hidden">
        <header class="game-header card">
            <div id="timer">--:--</div>
            <div id="round-info"></div>
            <div id="common-objective"><strong>Obiettivo Comune:</strong> <span></span></div>
        </header>
        <aside class="leaderboard card">
            <h3>Classifica</h3>
            <ul id="leaderboard-list"></ul>
        </aside>
        <main class="main-game">
            <div class="map-container"></div>
            <button id="confirm-choice-btn" disabled>Conferma Scelta</button>
            <div id="objectives-container" class="card">
                <h3>I Tuoi Obiettivi</h3>
                <div class="objective"><strong>Personale (Segreto):</strong> <span id="my-personal-objective"></span></div>
                <hr>
                <h3>Altri Giocatori</h3>
                <div id="other-objectives-list"></div>
            </div>
        </main>
        <aside class="chat-area card">
            <div class="chat-tabs" id="chat-tabs"></div>
            <div class="chat-windows" id="chat-windows"></div>
            <div class="chat-input">
                <input type="text" id="chat-message-input" placeholder="Scrivi un messaggio...">
                <button id="send-chat-btn">Invia</button>
            </div>
        </aside>
    </div>

    <div id="game-over-view" class="hidden">
        <div class="container">
            <h2>Partita Terminata!</h2>
            <h3>Classifica Finale</h3>
            <ol id="final-leaderboard"></ol>
            <p id="restarting-status">La lobby si riavvierà a breve...</p>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io("INCOLLA_QUI_L'URL_DEL_TUO_BACKEND");
            
            let mySid = '';
            let myUsername = '';
            let playersData = {};
            let selectedSquare = null;

            const lobbyView = document.getElementById('lobby-view');
            const gameView = document.getElementById('game-view');
            const gameOverView = document.getElementById('game-over-view');
            const confirmChoiceBtn = document.getElementById('confirm-choice-btn');

            function showView(viewName) {
                [lobbyView, gameView, gameOverView].forEach(v => v.classList.add('hidden'));
                document.getElementById(`${viewName}-view`).classList.remove('hidden');
            }
            
            function setupNewRound(data) {
                showView('game');
                playersData = data.players;
                selectedSquare = null;
                document.getElementById('round-info').textContent = `Round ${data.round_attuale} / ${data.num_round_totali}`;
                document.getElementById('common-objective').querySelector('span').textContent = data.obiettivo_comune_desc;
                confirmChoiceBtn.disabled = true;
                confirmChoiceBtn.textContent = 'Conferma Scelta';
                const mapContainer = document.querySelector('.map-container');
                mapContainer.innerHTML = '';
                for (let i = 1; i <= 12; i++) {
                    const square = document.createElement('div');
                    square.className = 'map-square';
                    square.dataset.square = i;
                    square.innerHTML = `<span class="square-number">${i}</span><div class="player-tokens"></div>`;
                    square.addEventListener('click', () => {
                        document.querySelectorAll('.map-square.selected').forEach(s => s.classList.remove('selected'));
                        square.classList.add('selected');
                        selectedSquare = i;
                        confirmChoiceBtn.disabled = false;
                    });
                    mapContainer.appendChild(square);
                }
                document.getElementById('my-personal-objective').textContent = data.obiettivi_personali[mySid].desc;
                const otherObjectivesList = document.getElementById('other-objectives-list');
                otherObjectivesList.innerHTML = '';
                for (const sid in playersData) {
                    if (sid === mySid) continue;
                    const p = playersData[sid];
                    const div = document.createElement('div');
                    div.innerHTML = `<strong>${p.username}:</strong> Obiettivo Personale Segreto`;
                    otherObjectivesList.appendChild(div);
                }
                updateLeaderboard(data.punteggi);
                setupChat(playersData);
            }

            function updateLeaderboard(scores) {
                const leaderboardList = document.getElementById('leaderboard-list');
                leaderboardList.innerHTML = '';
                const sortedPlayers = Object.values(playersData).sort((a, b) => (scores[b.id] || 0) - (scores[a.id] || 0));
                
                sortedPlayers.forEach(player => {
                    const score = scores[player.id] || 0;
                    const li = document.createElement('li');
                    li.id = `score-${player.id}`;
                    li.innerHTML = `<span><span class="player-id-color ${player.id}-token">${player.id}</span>${player.username}</span><strong>${score}</strong>`;
                    leaderboardList.appendChild(li);
                });
            }

            function setupChat(players) {
                const chatTabs = document.getElementById('chat-tabs');
                const chatWindows = document.getElementById('chat-windows');
                chatTabs.innerHTML = '';
                chatWindows.innerHTML = '';

                const globalTab = document.createElement('div');
                globalTab.className = 'chat-tab active';
                globalTab.dataset.chat = 'global';
                globalTab.textContent = 'Globale';
                globalTab.appendChild(document.createElement('span')).className = 'unread-dot';
                chatTabs.appendChild(globalTab);

                const globalWindow = document.createElement('div');
                globalWindow.className = 'chat-window';
                globalWindow.id = 'chat-window-global';
                chatWindows.appendChild(globalWindow);

                for(const sid in players) {
                    if(sid === mySid) continue;
                    const p = players[sid];
                    const tab = document.createElement('div');
                    tab.className = 'chat-tab';
                    tab.dataset.chat = sid;
                    tab.textContent = p.username;
                    tab.appendChild(document.createElement('span')).className = 'unread-dot';
                    chatTabs.appendChild(tab);
                    const windowEl = document.createElement('div');
                    windowEl.className = 'chat-window hidden';
                    windowEl.id = `chat-window-${sid}`;
                    chatWindows.appendChild(windowEl);
                }
                
                chatTabs.addEventListener('click', e => {
                    const tab = e.target.closest('.chat-tab');
                    if (!tab) return;
                    
                    tab.classList.remove('has-unread');

                    const targetChat = tab.dataset.chat;
                    chatTabs.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    chatWindows.querySelectorAll('.chat-window').forEach(w => w.classList.add('hidden'));
                    document.getElementById(`chat-window-${targetChat}`).classList.remove('hidden');
                });
            }
            socket.on('connect', () => { mySid = socket.id; });
            socket.on('welcome', (data) => {
                const playerList = document.getElementById('player-list');
                playerList.innerHTML = '';
                data.all_players.forEach(p_name => {
                    const li = document.createElement('li');
                    li.textContent = p_name;
                    playerList.appendChild(li);
                });
                document.getElementById('lobby-status').textContent = `Giocatori connessi: ${data.all_players.length}`;
            });
            socket.on('player_joined', (data) => {
                const playerList = document.getElementById('player-list');
                const li = document.createElement('li');
                li.textContent = data.new_player_name;
                playerList.appendChild(li);
                const currentCount = document.querySelectorAll('#player-list li').length;
                document.getElementById('lobby-status').textContent = `Giocatori connessi: ${currentCount}`;
            });
            socket.on('player_left', (data) => {
                 const playerList = document.getElementById('player-list');
                 playerList.querySelectorAll('li').forEach(li => {
                     if (li.textContent === data.username) li.remove();
                 });
                 const currentCount = document.querySelectorAll('#player-list li').length;
                 document.getElementById('lobby-status').textContent = `Giocatori connessi: ${currentCount}`;
            });
            socket.on('game_starting', () => { document.getElementById('lobby-status').textContent = 'Partita in avvio...'; });
            socket.on('error', (data) => { 
                alert("Errore: " + data.msg);
                const playerList = document.getElementById('player-list');
                playerList.querySelectorAll('li').forEach(li => { if (li.textContent === myUsername) li.remove(); });
                document.getElementById('join-form').classList.remove('hidden');
                document.getElementById('lobby-status').textContent = 'Errore. Riprova.';
            });
            socket.on('new_round', setupNewRound);
            socket.on('timer_update', (data) => {
                const timerEl = document.getElementById('timer');
                if (timerEl) timerEl.textContent = new Date(data.time * 1000).toISOString().substr(14, 5);
            });
            socket.on('choice_confirmed', () => { 
                document.querySelector('.map-square.selected')?.classList.add('confirmed');
                confirmChoiceBtn.disabled = true;
                confirmChoiceBtn.textContent = 'Scelta Inviata';
                document.querySelectorAll('.map-square').forEach(s => {
                    s.style.pointerEvents = 'none';
                });
            });
            socket.on('round_reveal', (data) => {
                document.querySelectorAll('.map-square').forEach(s => s.style.pointerEvents = 'none');
                for(const playerId in data.choices) {
                    const squareEl = document.querySelector(`[data-square="${data.choices[playerId]}"]`);
                    if(squareEl) {
                        const token = document.createElement('div');
                        token.className = `player-token ${playerId}-token`;
                        token.textContent = playerId.substring(1);
                        squareEl.querySelector('.player-tokens').appendChild(token);
                    }
                }
                setTimeout(() => {
                    updateLeaderboard(data.punteggi);
                    Object.keys(data.punteggi).forEach(pid => {
                        const scoreEl = document.getElementById(`score-${pid}`);
                        if (scoreEl) scoreEl.classList.add('score-update');
                    });
                }, 1000);
            });
            socket.on('game_over', (data) => {
                showView('game-over');
                const finalLeaderboard = document.getElementById('final-leaderboard');
                finalLeaderboard.innerHTML = '';
                data.classifica.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p[0]} - ${p[1]} punti`;
                    finalLeaderboard.appendChild(li);
                });
            });
            socket.on('lobby_reset', () => { location.reload(); });
            socket.on('new_message', (data) => {
                const targetId = data.to === 'global' ? 'global' : (data.sender_sid === mySid ? data.to : data.sender_sid);
                const win = document.getElementById(`chat-window-${targetId}`);
                if (win) {
                    win.innerHTML += `<p><strong>${data.sender}:</strong> ${data.message}</p>`;
                    win.scrollTop = win.scrollHeight;
                    const chatTab = document.querySelector(`.chat-tab[data-chat="${targetId}"]`);
                    if (chatTab && !chatTab.classList.contains('active')) {
                        chatTab.classList.add('has-unread');
                    }
                }
            });
            const usernameInput = document.getElementById('username-input');
            const joinBtn = document.getElementById('join-btn');
            function joinGame() {
                myUsername = usernameInput.value.trim() || `Giocatore${Math.floor(Math.random() * 100)}`;
                const playerList = document.getElementById('player-list');
                const tempLi = document.createElement('li');
                tempLi.textContent = myUsername;
                tempLi.style.color = '#555';
                playerList.appendChild(tempLi);
                document.getElementById('join-form').classList.add('hidden');
                document.getElementById('lobby-status').textContent = 'Connessione in corso...';
                socket.emit('join', { username: myUsername });
            }
            joinBtn.addEventListener('click', joinGame);
            usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { joinGame(); } });
            if(confirmChoiceBtn) {
                confirmChoiceBtn.addEventListener('click', () => {
                    if (selectedSquare !== null) socket.emit('make_choice', { choice: selectedSquare });
                });
            }
            const sendChatBtn = document.getElementById('send-chat-btn');
            if(sendChatBtn) {
                sendChatBtn.addEventListener('click', () => {
                    const input = document.getElementById('chat-message-input');
                    const message = input.value.trim();
                    const activeTab = document.querySelector('.chat-tab.active');
                    if (message && activeTab) {
                        const targetSid = activeTab.dataset.chat;
                        socket.emit('send_message', { message: message, to: targetSid });
                        input.value = '';
                    }
                });
            }
            showView('lobby');
        });
    </script>
</body>
</html>