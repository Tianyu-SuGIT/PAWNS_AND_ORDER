<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>PAWNS</title>
    <style>
        :root { --c-blue: #007bff; --c-green: #28a745; --c-red: #d9534f; --c-yellow: #ffc107; --c-light-gray: #f8f9fa; --c-white: #fff; --c-text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f4f9; color: var(--c-text); font-size: 16px; }
        .hidden { display: none !important; }
        .card { background: var(--c-white); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        button { padding: 10px 20px; border: none; border-radius: 4px; background-color: var(--c-blue); color: white; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; } .btn-secondary:hover { background-color: #5a6268; }
        #lobby-view, #game-over-view { text-align: center; padding-top: 50px; }
        .container { background-color: var(--c-white); margin: auto; padding: 20px 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 600px; }
        #player-list { list-style-type: none; padding: 0; }
        #player-list li { background-color: #e7f3ff; margin: 5px 0; padding: 10px; border-radius: 4px; }
        #lobby-view input[type="text"] { padding: 10px; width: 60%; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #lobby-status { margin-top: 20px; font-weight: bold; min-height: 20px; color: var(--c-blue); }
        #game-view { display: grid; grid-template-columns: 280px 1fr 320px; grid-template-rows: auto 1fr; gap: 20px; padding: 20px; max-width: 1500px; margin: auto; height: 95vh; }
        .game-header { grid-column: 1 / -1; text-align: center; }
        .leaderboard { grid-column: 1; grid-row: 2; }
        .main-game { grid-column: 2; grid-row: 2; display: flex; flex-direction: column; text-align: center; }
        .chat-area { grid-column: 3; grid-row: 2; display: flex; flex-direction: column; }
        #timer { font-size: 1.8em; font-weight: bold; color: var(--c-red); }
        #round-info { font-size: 1.2em; }
        #leaderboard-list { list-style: none; padding: 0; }
        #leaderboard-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; transition: all 0.3s; }
        #leaderboard-list li.player-confirmed span:first-child { color: var(--c-green); font-weight: bold; }
        .player-id-color { padding: 2px 6px; border-radius: 4px; color: white; margin-right: 8px; }
        .map-container { display: flex; justify-content: center; align-items: center; padding: 20px; background: #f0f0f0; border-radius: 8px; margin: 20px 0; }
        .map-square { width: 60px; height: 60px; border: 2px solid #ccc; background: var(--c-white); margin: 0 5px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; font-weight: bold; cursor: pointer; transition: all 0.2s ease; border-radius: 6px; position: relative; }
        .map-square.selected { border-color: var(--c-blue); transform: scale(1.05); }
        .square-number { font-size: 0.8em; color: #888; margin-top: 4px; }
        .player-tokens { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; flex-grow: 1; }
        .player-token { width: 20px; height: 20px; border-radius: 50%; color: white; font-size: 0.8em; display: flex; justify-content: center; align-items: center; margin: 1px; }
        .G1-token { background-color: #d9534f; } .G1-bg { background: #d9534f; }
        .G2-token { background-color: #5bc0de; } .G2-bg { background: #5bc0de; }
        .G3-token { background-color: #5cb85c; } .G3-bg { background: #5cb85c; }
        .G4-token { background-color: #f0ad4e; } .G4-bg { background: #f0ad4e; }
        .G5-token { background-color: #6f42c1; } .G5-bg { background: #6f42c1; }
        .G6-token { background-color: #6610f2; } .G6-bg { background: #6610f2; }
        .actions-container { display: flex; justify-content: center; gap: 10px; margin: 10px auto; height: 40px;}
        #objectives-container { background: #e7f3ff; padding: 20px; border-radius: 8px; font-size: 1.1em; border: 2px solid var(--c-blue); text-align: left; }
        .objective { margin-bottom: 10px; }
        .objective strong { color: var(--c-blue); display: block; margin-bottom: 5px; }
        .chat-tabs { display: flex; border-bottom: 1px solid #ccc; }
        .chat-tab { position: relative; padding: 10px 15px; cursor: pointer; background: #eee; border-top-left-radius: 4px; border-top-right-radius: 4px; }
        .chat-tab.active { background: var(--c-white); border-bottom: 1px solid var(--c-white); margin-bottom: -1px; font-weight: bold; }
        .unread-dot { position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background-color: var(--c-red); border-radius: 50%; display: none; }
        .chat-tab.has-unread .unread-dot { display: block; }
        .chat-window { flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; border-top: none; padding: 10px; }
        .chat-window p { margin: 0 0 5px 0; padding: 0; font-size: 0.95em; }
        .chat-input { display: flex; margin-top: 10px; }
        .chat-input input { flex-grow: 1; border: 1px solid #ccc; padding: 8px; border-radius: 4px 0 0 4px; }
        .chat-input button { border-radius: 0 4px 4px 0; }
    </style>
</head>
<body>
    <div id="lobby-view">
        <div class="container">
            <h1>PAWNS</h1>
            <h2>Lobby</h2>
            <div id="join-form"> <input type="text" id="username-input" placeholder="Inserisci il tuo nome..."> <button id="join-btn">Entra</button> </div>
            <hr>
            <h3>Giocatori Connessi:</h3>
            <ul id="player-list"></ul>
            <p id="lobby-status">Connessione al server...</p>
            <div id="game-rules" class="card" style="margin-top: 20px; text-align: left;">
                <h3>Regole del Gioco</h3>
                <p>Benvenuto a PAWNS! L'obiettivo è accumulare più punti degli altri in 5 round, ma non sarà semplice. Ogni tua scelta sarà un dilemma strategico.</p>
                <h4>Obiettivi del Round</h4>
                <ul>
                    <li><strong>Obiettivo Comune:</strong> Una condizione visibile a tutti che crea punti di scontro sulla mappa.</li>
                    <li><strong>Obiettivo Personale:</strong> Un obiettivo segreto, fisso per tutta la partita. Potrai cambiarlo una sola volta. Potrebbe chiederti di prevedere le mosse di un avversario, di sabotare i piani altrui o di collaborare in modi inaspettati.</li>
                </ul>
                <h4>Punteggio e Conflitti</h4>
                <ul>
                    <li>Se termini un round su una casella con altri giocatori, **generalmente non ottieni punti**.</li>
                    <li><strong>L'eccezione:</strong> Alcuni Obiettivi Comuni potrebbero **cambiare le regole**, premiando esplicitamente chi forma una coppia su una casella.</li>
                </ul>
                <p>Dovrai decidere se rischiare per l'obiettivo comune o giocare sul sicuro per il tuo obiettivo segreto.</p>
                 <h4>Info Generali</h4>
                <ul> <li><strong>Giocatori:</strong> 4-6.</li> <li><strong>Timer di Round:</strong> 3 minuti.</li> <li><strong>Vincitore:</strong> Chi ha più punti dopo 5 round vince!</li> </ul>
            </div>
        </div>
    </div>

    <div id="game-view" class="hidden">
        <header class="game-header card"> <div id="timer">--:--</div> <div id="round-info"></div> </header>
        <aside class="leaderboard card"> <h3>Classifica</h3> <ul id="leaderboard-list"></ul> </aside>
        <main class="main-game">
            <div class="map-container"></div>
            <div class="actions-container">
                <button id="confirm-choice-btn" class="hidden">Conferma Scelta</button>
                <button id="cancel-choice-btn" class="btn-secondary hidden">Annulla Scelta</button>
            </div>
            <div id="objectives-container" class="card">
                <div class="objective"> <strong>Obiettivo Personale:</strong> <span id="my-personal-objective"></span> </div>
                <button id="reroll-btn" class="btn-secondary" style="width:100%; margin-top:5px;">Nuovo Obiettivo (1 rimasto)</button>
                <hr>
                <div class="objective"> <strong>Obiettivo Comune:</strong> <span id="common-objective-text"></span> </div>
            </div>
        </main>
        <aside class="chat-area card">
            <div class="chat-tabs" id="chat-tabs"></div>
            <div class="chat-windows" id="chat-windows"></div>
            <div class="chat-input"> <input type="text" id="chat-message-input" placeholder="Scrivi un messaggio..."> <button id="send-chat-btn">Invia</button> </div>
        </aside>
    </div>

    <div id="game-over-view" class="hidden">
        <div class="container">
            <h2>Partita Terminata!</h2>
            <h3>Classifica Finale</h3>
            <ol id="final-leaderboard"></ol>
            <p id="restarting-status">La lobby si riavvierà a breve...</p>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io("https://horse-race-irrb.onrender.com");
            let mySid = '', myUsername = '', myPlayerId = '', playersData = {}, confirmedPlayers = new Set(), selectedSquare = null;
            const ui = {
                lobbyView: document.getElementById('lobby-view'),
                gameView: document.getElementById('game-view'),
                gameOverView: document.getElementById('game-over-view'),
                confirmBtn: document.getElementById('confirm-choice-btn'),
                cancelBtn: document.getElementById('cancel-choice-btn'),
                rerollBtn: document.getElementById('reroll-btn'),
                chatInput: document.getElementById('chat-message-input'),
                sendChatBtn: document.getElementById('send-chat-btn'),
                usernameInput: document.getElementById('username-input'),
                joinBtn: document.getElementById('join-btn')
            };

            function showView(viewName) { [ui.lobbyView, ui.gameView, ui.gameOverView].forEach(v => v.classList.add('hidden')); document.getElementById(`${viewName}-view`).classList.remove('hidden'); }
            function getPlayerColorClass(playerId) { return `${playerId}-bg`; }

            function setupNewRound(data) {
                showView('game');
                playersData = data.players;
                myPlayerId = playersData[mySid]?.id;
                selectedSquare = null;
                confirmedPlayers.clear();
                
                document.getElementById('round-info').textContent = `Round ${data.round_attuale} / ${data.num_round_totali}`;
                document.getElementById('common-objective-text').textContent = data.obiettivo_comune_desc;
                
                if (data.player_rerolls.includes(mySid)) {
                    ui.rerollBtn.textContent = 'Nuovo Obiettivo (Usato)';
                    ui.rerollBtn.disabled = true;
                } else {
                    ui.rerollBtn.textContent = 'Nuovo Obiettivo (1 rimasto)';
                    ui.rerollBtn.disabled = false;
                }

                ui.confirmBtn.classList.add('hidden');
                ui.cancelBtn.classList.add('hidden');
                
                const mapContainer = document.querySelector('.map-container');
                mapContainer.innerHTML = '';
                for (let i = 1; i <= 12; i++) {
                    const square = document.createElement('div');
                    square.className = 'map-square';
                    square.dataset.square = i;
                    square.innerHTML = `<span class="square-number">${i}</span><div class="player-tokens"></div>`;
                    square.addEventListener('click', (e) => {
                        document.querySelectorAll('.map-square.selected').forEach(s => s.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        selectedSquare = i;
                        ui.confirmBtn.classList.remove('hidden');
                        ui.confirmBtn.disabled = false;
                        ui.cancelBtn.classList.add('hidden');
                    });
                    mapContainer.appendChild(square);
                }
                
                document.getElementById('my-personal-objective').textContent = data.obiettivi_personali[mySid].desc;
                updateLeaderboard(data.punteggi, data.players);
                setupChat(playersData);
            }

            function updateLeaderboard(scores, currentPlayers) {
                const leaderboardList = document.getElementById('leaderboard-list');
                leaderboardList.innerHTML = '';
                const sortedPlayers = Object.entries(currentPlayers).sort(([, a], [, b]) => (scores[b.id] || 0) - (scores[a.id] || 0));
                sortedPlayers.forEach(([sid, player]) => {
                    const score = scores[player.id] || 0;
                    const li = document.createElement('li');
                    li.dataset.sid = sid;
                    li.id = `score-${player.id}`;
                    li.innerHTML = `<span><span class="player-id-color ${player.id}-token">${player.id}</span>${player.username}</span><strong>${score}</strong>`;
                    if (confirmedPlayers.has(sid)) li.classList.add('player-confirmed');
                    leaderboardList.appendChild(li);
                });
            }
            
            function setupChat(players) { /* ... (invariato) ... */ }

            // --- GESTIONE SOCKET ---
            socket.on('connect', () => { mySid = socket.id; });
            socket.on('new_round', setupNewRound);
            
            socket.on('choice_confirmed', () => { 
                document.querySelectorAll('.map-square').forEach(s => s.style.pointerEvents = 'none');
                const selectedEl = document.querySelector(`[data-square="${selectedSquare}"]`);
                if (selectedEl) {
                    selectedEl.classList.remove('selected');
                    selectedEl.classList.add(getPlayerColorClass(myPlayerId));
                }
                ui.confirmBtn.classList.add('hidden');
                ui.cancelBtn.classList.remove('hidden');
                ui.cancelBtn.disabled = false; // Assicura che sia abilitato
            });
            
            socket.on('new_personal_objective', (data) => {
                document.getElementById('my-personal-objective').textContent = data.desc;
                ui.rerollBtn.textContent = 'Nuovo Obiettivo (Usato)';
                ui.rerollBtn.disabled = true;
            });
            
            socket.on('player_confirmed', (data) => {
                confirmedPlayers.add(data.sid);
                const playerLi = document.querySelector(`#leaderboard-list li[data-sid="${data.sid}"]`);
                if (playerLi) playerLi.classList.add('player-confirmed');
                
                const totalPlayers = Object.keys(playersData).length;
                if (confirmedPlayers.size >= totalPlayers - 1 && !confirmedPlayers.has(mySid)) {
                    ui.cancelBtn.disabled = true;
                }
            });

            socket.on('player_choice_cancelled', (data) => {
                confirmedPlayers.delete(data.sid);
                const playerLi = document.querySelector(`#leaderboard-list li[data-sid="${data.sid}"]`);
                if (playerLi) playerLi.classList.remove('player-confirmed');
                if (ui.cancelBtn.disabled) ui.cancelBtn.disabled = false;
            });

            socket.on('choice_cancelled_ok', () => {
                document.querySelectorAll('.map-square').forEach(s => {
                    s.style.pointerEvents = 'auto';
                    s.classList.remove(getPlayerColorClass(myPlayerId));
                });
                document.querySelector(`[data-square="${selectedSquare}"]`)?.classList.add('selected');
                ui.cancelBtn.classList.add('hidden');
                ui.confirmBtn.classList.remove('hidden');
            });
            
            socket.on('round_reveal', (data) => {
                const squareToPlayers = {};
                Object.entries(data.choices).forEach(([playerId, squareNum]) => {
                    if (squareNum > 0) {
                        if (!squareToPlayers[squareNum]) squareToPlayers[squareNum] = [];
                        squareToPlayers[squareNum].push(playerId);
                    }
                });

                document.querySelectorAll('.map-square').forEach(squareEl => {
                    squareEl.style.pointerEvents = 'none';
                    const squareNum = squareEl.dataset.square;
                    const playersOnSquare = squareToPlayers[squareNum];
                    if (playersOnSquare) {
                        if (playersOnSquare.length === 1) {
                            squareEl.className = `map-square ${getPlayerColorClass(playersOnSquare[0])}`;
                        } else {
                            const colors = playersOnSquare.map(pid => `var(--c-text, black)`); // Placeholder for actual color variables if needed
                            const colorClasses = playersOnSquare.map(pid => getPlayerColorClass(pid));
                            // This is a simplified split, more complex logic can be added
                             const gradient = colorClasses.map((c, i) => `var(--${c.replace('-bg','-token')}) ${i * (100/colorClasses.length)}%, var(--${c.replace('-bg','-token')}) ${(i+1) * (100/colorClasses.length)}%`).join(', ');
                             squareEl.style.background = `linear-gradient(135deg, ${gradient})`;
                        }
                    }
                });
                setTimeout(() => { updateLeaderboard(data.punteggi, playersData); }, 1000);
            });

            socket.on('welcome', (data) => { /* ... (invariato) ... */ });
            socket.on('player_joined', (data) => { /* ... (invariato) ... */ });
            socket.on('player_left', (data) => { /* ... (invariato) ... */ });
            socket.on('game_starting', () => { document.getElementById('lobby-status').textContent = 'Partita in avvio...'; });
            socket.on('error', (data) => { /* ... (invariato) ... */ });
            socket.on('timer_update', (data) => {
                const timerEl = document.getElementById('timer');
                if (timerEl) timerEl.textContent = new Date(data.time * 1000).toISOString().substr(14, 5);
            });
            socket.on('game_over', (data) => { /* ... (invariato) ... */ });
            socket.on('lobby_reset', () => { location.reload(); });
            socket.on('new_message', (data) => { /* ... (invariato) ... */ });

            // --- LISTENER PER I PULSANTI E AZIONI ---
            ui.confirmBtn.addEventListener('click', () => { if (selectedSquare !== null) socket.emit('make_choice', { choice: selectedSquare }); });
            ui.cancelBtn.addEventListener('click', () => socket.emit('cancel_choice'));
            ui.rerollBtn.addEventListener('click', () => { if(confirm('Sei sicuro di voler usare il tuo unico reroll?')) socket.emit('reroll_objective'); });
            function joinGame() {
                myUsername = ui.usernameInput.value.trim() || `Giocatore${Math.floor(Math.random() * 100)}`;
                document.getElementById('join-form').classList.add('hidden');
                document.getElementById('lobby-status').textContent = 'Connessione in corso...';
                socket.emit('join', { username: myUsername });
            }
            ui.joinBtn.addEventListener('click', joinGame);
            ui.usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') joinGame(); });
            function sendChatMessage() {
                const message = ui.chatInput.value.trim();
                const activeTab = document.querySelector('.chat-tab.active');
                if (message && activeTab) {
                    socket.emit('send_message', { message: message, to: activeTab.dataset.chat });
                    ui.chatInput.value = '';
                }
            }
            ui.sendChatBtn.addEventListener('click', sendChatMessage);
            ui.chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendChatMessage(); } });
            
            showView('lobby');
        });
    </script>
</body>
</html>